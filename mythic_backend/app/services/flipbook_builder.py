# app/services/flipbook_builder.py
import json
import re
import datetime
from pathlib import Path
from jinja2 import Environment, FileSystemLoader
import markdown
from app.services.llm_client import generate_text
from app.services.book_builder import analyze_profile_data

# –ø–æ–¥–∫–ª—é—á–∞–µ–º —à–∞–±–ª–æ–Ω—ã –∏–∑ –ø–∞–ø–∫–∏ app/templates
env = Environment(loader=FileSystemLoader('app/templates'))

def strip_hashtags(text: str) -> str:
    """–£–±–∏—Ä–∞–µ–º –≤—Å–µ #—Ö—ç—à—Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    return re.sub(r'\B#\w+\b', '', text).strip()

def generate_pages_html(run_id: str, image_paths: list[str], text_pages: list[str]) -> list[str]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ñ–ª–∏–ø–±—É–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "—Ä–∞–∑–≤–æ—Ä–æ—Ç–æ–≤": —Ç–µ–∫—Å—Ç —Å–ª–µ–≤–∞, —Ñ–æ—Ç–æ —Å–ø—Ä–∞–≤–∞.
    """
    print("üìö –°–æ–±–∏—Ä–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ñ–ª–∏–ø–±—É–∫–∞ –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ...")
    
    pages = []

    # ========== –û–ë–õ–û–ñ–ö–ê ==========
    pages.append("""
      <div class="cover-page">
        <h1>–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è<br>–ò—Å—Ç–æ—Ä–∏—è</h1>
        <p><i>–° –ª—é–±–æ–≤—å—é —Å–æ–∑–¥–∞–Ω–æ –¥–ª—è —Ç–µ–±—è...</i></p>
        <div class="cover-decoration">üíï</div>
      </div>
    """)

    # ========== –¢–ò–¢–£–õ–¨–ù–´–ô –õ–ò–°–¢ ==========
    pages.append("""
        <div class="page-content title-page">
            <h1>–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è<br>–ò—Å—Ç–æ—Ä–∏—è</h1>
            <p>—Å–æ–∑–¥–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∏ –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ–º</p>
            <div class="title-decoration">
                <div class="heart">‚ô•</div>
                <div class="date">""" + f"{datetime.datetime.now().strftime('%B %Y')}" + """</div>
            </div>
        </div>
    """)

    # ========== –ó–ê–ì–†–£–ñ–ê–ï–ú –ü–†–û–§–ò–õ–¨ –î–õ–Ø –ö–û–ù–¢–ï–ö–°–¢–ê ==========
    profile_path = Path("data") / run_id / "posts.json"
    profile_data = []
    if profile_path.exists():
        try:
            profile_data = json.loads(profile_path.read_text(encoding="utf-8"))
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å posts.json: {e}")

    profile_ctx = analyze_profile_data(profile_data) if profile_data else {}
    full_name = profile_ctx.get("full_name") or profile_ctx.get("username") or "—ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞"
    raw_comments = [post.get("caption", "") for post in profile_data[0].get("latestPosts", [])] if profile_data else []

    # ========== –ü–†–û–õ–û–ì ==========
    prologue = generate_section_text(
        role="–ü—Ä–æ–ª–æ–≥",
        full_name=full_name,
        prompt=f"""–ù–∞–ø–∏—à–∏ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–ª–æ–≥ (120-150 —Å–ª–æ–≤) –∫ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –∫–Ω–∏–≥–µ 
        –æ —á–µ–ª–æ–≤–µ–∫–µ –ø–æ –∏–º–µ–Ω–∏ {full_name}. –ü–∏—à–∏ —Ç–µ–ø–ª–æ, –ª–∏—á–Ω–æ—Å—Ç–Ω–æ, –∫–∞–∫ –≤–ª—é–±–ª—ë–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ–∫.
        –ò—Å–ø–æ–ª—å–∑—É–π '—Ç—ã' –æ–±—Ä–∞—â–µ–Ω–∏–µ. –ü—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞—á–∞–ª–æ–º –∫—Ä–∞—Å–∏–≤–æ–π –∏—Å—Ç–æ—Ä–∏–∏."""
    )
    
    pages.append(f"""
      <div class="page-content text-content prologue">
        <h2>–ü—Ä–æ–ª–æ–≥</h2>
        {markdown.markdown(prologue)}
      </div>
    """)

    # ========== –û–ì–õ–ê–í–õ–ï–ù–ò–ï ==========
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –≥–ª–∞–≤
    toc_summaries = generate_toc_summaries(
        full_name=full_name,
        image_count=len(image_paths),
        raw_comments=raw_comments
    )
    
    toc_items = "".join(f"<li>{summary}</li>" for summary in toc_summaries)
    pages.append(f"""
      <div class="page-content toc-page">
        <h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h2>
        <ol class="toc">{toc_items}</ol>
      </div>
    """)

    # ========== –û–°–ù–û–í–ù–´–ï –†–ê–ó–í–û–†–û–¢–´ (–¢–ï–ö–°–¢ + –§–û–¢–û) ==========
    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –º–∞–ª–æ, –¥–µ–ª–∏–º –ø–µ—Ä–≤—É—é –Ω–∞ —á–∞—Å—Ç–∏
    if len(text_pages) < 12 and text_pages:
        first_text = strip_hashtags(text_pages[0])
        words = first_text.split()
        if len(words) > 300:  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –¥–µ–ª–∏—Ç—å
            chunk_size = max(150, len(words)//10)
            new_pages = [" ".join(words[i:i+chunk_size]) for i in range(0, len(words), chunk_size)]
            text_pages = new_pages[:12] + text_pages[1:]

    for idx, img_path in enumerate(image_paths):
        # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –æ—á–∏—â–∞–µ–º –æ—Ç —Ö—ç—à—Ç–µ–≥–æ–≤
        raw_text = text_pages[idx] if idx < len(text_pages) else ""
        raw_text = strip_hashtags(raw_text)

        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –º–∞–ª–æ (<350 —Å–∏–º–≤–æ–ª–æ–≤) ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ LLM
        if len(raw_text.strip()) < 350:
            try:
                prompt = f"""–¢—ã ‚Äî —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. –ù–∞–ø–∏—à–∏ 5-6 –∞–±–∑–∞—Ü–µ–≤ (‚âà500-600 —Å–ª–æ–≤) –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–ª–∏–ø–±—É–∫–∞ –æ {full_name}. 
                –≠—Ç–æ —Ç–µ–∫—Å—Ç –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ‚Ññ{idx+1}. –î–æ–ª–∂–Ω–æ –∑–≤—É—á–∞—Ç—å –ª–∏—á–Ω–æ, —Ç–µ–ø–ª–æ, –ø–æ—ç—Ç–∏—á–Ω–æ, –æ–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "—Ç—ã". 
                –°–≤—è–∂–∏ —Ä–∞—Å—Å–∫–∞–∑ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏ —Å–æ–∑–¥–∞–≤–∞–π –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é. 
                –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å –¥–Ω–µ–≤–Ω–∏–∫–∞ –≤–ª—é–±–ª—ë–Ω–Ω–æ–≥–æ, –∏–∑–±–µ–≥–∞–π —à—Ç–∞–º–ø–æ–≤ –∏ –∫–ª–∏—à–µ.
                –û–ø–∏—Å—ã–≤–∞–π –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≤–∏–¥–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ, –Ω–æ –∏ —á—É–≤—Å—Ç–≤–∞, —ç–º–æ—Ü–∏–∏, –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è."""
                
                raw_text = generate_text(prompt, max_tokens=1800, temperature=0.85)
                print(f"üí¨ LLM —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã {idx+1} (–¥–ª–∏–Ω–∞ {len(raw_text)} —Å–∏–º–≤–æ–ª–æ–≤)")
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ LLM –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã {idx+1}: {e}")
                print(f"üìù –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã {idx+1}")
                
                # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–µ fallback —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                fallback_texts = [
                    f"""–≠—Ç–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é {full_name} ‚Äî —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –∫—Ä–∞—Å–æ—Ç—É –≤ –∫–∞–∂–¥–æ–º –º–æ–º–µ–Ω—Ç–µ.

                    –í–∑–≥–ª—è–Ω–∏ –Ω–∞ —ç—Ç–æ—Ç –∫–∞–¥—Ä ‚Äî –∑–¥–µ—Å—å —Å—Ç–æ–ª—å–∫–æ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ö–∞–∂–¥–∞—è –¥–µ—Ç–∞–ª—å –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, –∫–∞–∫ {full_name} –ø—Ä–æ–∂–∏–≤–∞–µ—Ç —Å–≤–æ—é –∂–∏–∑–Ω—å: —è—Ä–∫–æ, —Å–º–µ–ª–æ, —Å –æ—Ç–∫—Ä—ã—Ç—ã–º —Å–µ—Ä–¥—Ü–µ–º.

                    –í —ç—Ç–æ–º —Å–Ω–∏–º–∫–µ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –º–æ–º–µ–Ω—Ç, –∞ —á–∞—Å—Ç–∏—á–∫—É –¥—É—à–∏. –≠–Ω–µ—Ä–≥–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∏—Å—Ö–æ–¥–∏—Ç –æ—Ç {full_name}, —Å–æ–≥—Ä–µ–≤–∞–µ—Ç –≤—Å–µ—Ö –≤–æ–∫—Ä—É–≥ –∏ –¥–µ–ª–∞–µ—Ç –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å –æ—Å–æ–±–µ–Ω–Ω—ã–º.

                    –≠—Ç–æ –Ω–∞—á–∞–ª–æ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –æ —á–µ–ª–æ–≤–µ–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—Ä–∏—Ç –º–∏—Ä—É —Å–≤–µ—Ç –ø—Ä–æ—Å—Ç–æ —Ç–µ–º, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.""",
                    
                    f"""–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –¥–µ–Ω—å –≤ –∂–∏–∑–Ω–∏ {full_name} ‚Äî —ç—Ç–æ –Ω–æ–≤–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ, –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∏–≤–ª—è—Ç—å –º–∏—Ä —Å–≤–æ–µ–π –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å—é.

                    –ù–∞ —ç—Ç–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—Ä–µ–º—è —Å–ª–æ–≤–Ω–æ –∑–∞–º–µ—Ä–ª–æ, –∑–∞–ø–µ—á–∞—Ç–ª–µ–≤ —Ç–æ—Ç —Å–∞–º—ã–π –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å—á–∞—Å—Ç—å–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º—ã–º. –£–ª—ã–±–∫–∞, –≤–∑–≥–ª—è–¥, –∫–∞–∂–¥—ã–π –∂–µ—Å—Ç ‚Äî –≤—Å—ë –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ –∂–∏–∑–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞.

                    {full_name} –æ–±–ª–∞–¥–∞–µ—Ç —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–º –¥–∞—Ä–æ–º ‚Äî –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –æ–±—ã—á–Ω—ã–µ –º–≥–Ω–æ–≤–µ–Ω–∏—è –≤ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–æ–≥—Ä–µ–≤–∞—Ç—å —Å–µ—Ä–¥—Ü–µ –≥–æ–¥–∞–º–∏. –≠—Ç–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤–∏–¥–µ—Ç—å –∫—Ä–∞—Å–æ—Ç—É —Ç–∞–º, –≥–¥–µ –¥—Ä—É–≥–∏–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–∏–º–æ, –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥—É—é –≤—Å—Ç—Ä–µ—á—É —Å {full_name} –æ—Å–æ–±–µ–Ω–Ω–æ–π.

                    –≠—Ç–æ—Ç –∫–∞–¥—Ä ‚Äî —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ —Ç–æ–≥–æ, –∫–∞–∫ –≤–∞–∂–Ω–æ —É–º–µ—Ç—å —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ—Å—Ç—ã–º –≤–µ—â–∞–º.""",
                    
                    f"""–í—Ä–µ–º—è —Ç–µ—á—ë—Ç, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–º–µ–Ω—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è —Å –Ω–∞–º–∏ –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è ‚Äî –æ–¥–∏–Ω –∏–∑ —Ç–∞–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –≤ –∂–∏–∑–Ω–∏ {full_name}.

                    –ó–¥–µ—Å—å –∑–∞–ø–µ—á–∞—Ç–ª–µ–Ω–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å—Ü–µ–Ω–∞ –∏–∑ –∂–∏–∑–Ω–∏, –∞ —ç–º–æ—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ —ç–∫—Ä–∞–Ω. –ö–æ–≥–¥–∞ —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ {full_name}, –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –∫—Ä–∞—Å–æ—Ç–∞ ‚Äî —ç—Ç–æ –Ω–µ –≤–Ω–µ—à–Ω–æ—Å—Ç—å, –∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å.

                    –ö–∞–∂–¥—ã–π –¥–µ–Ω—å {full_name} –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∂–∏–∑–Ω—å —Å—Ç–æ–∏—Ç —Ç–æ–≥–æ, —á—Ç–æ–±—ã –µ—ë –ø—Ä–æ–∂–∏–≤–∞—Ç—å –ø–æ–ª–Ω–æ –∏ —è—Ä–∫–æ. –≠—Ç–æ—Ç —Å–Ω–∏–º–æ–∫ ‚Äî –º–∞–ª–µ–Ω—å–∫–æ–µ –æ–∫–Ω–æ –≤ –º–∏—Ä, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç —Ü–µ–Ω–∏—Ç—Å—è –∏ –ø–æ–º–Ω–∏—Ç—Å—è.

                    –¢–∞–∫–∏–µ –ª—é–¥–∏, –∫–∞–∫ {full_name}, –Ω–∞–ø–æ–º–∏–Ω–∞—é—Ç –Ω–∞–º, —á—Ç–æ —Å—á–∞—Å—Ç—å–µ ‚Äî —ç—Ç–æ –Ω–µ —Ü–µ–ª—å, –∞ —Å–ø–æ—Å–æ–± –∂–∏–∑–Ω–∏."""
                ]
                
                # –¶–∏–∫–ª–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
                selected_text = fallback_texts[idx % len(fallback_texts)]
                raw_text = raw_text or selected_text

        # –õ–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –¢–µ–∫—Å—Ç
        html_txt = markdown.markdown(raw_text)
        pages.append(f"""
          <div class="page-content text-content chapter">
            <h3>–ì–ª–∞–≤–∞ {idx+1}</h3>
            {html_txt}
          </div>
        """)

        # –ü—Ä–∞–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äî –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        fn = Path(img_path).name
        pages.append(f"""
          <div class="page-image">
            <img src="/data/{run_id}/images/{fn}" 
                 alt="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è {idx+1}" 
                 onerror="this.onerror=null;this.src='/static/img/fallback.jpg';"/>
            <div class="image-caption">–ì–ª–∞–≤–∞ {idx+1}</div>
          </div>
        """)
        
    # ========== –≠–ü–ò–õ–û–ì ==========
    epilogue = generate_section_text(
        role="–≠–ø–∏–ª–æ–≥",
        full_name=full_name,
        prompt=f"""–ù–∞–ø–∏—à–∏ —Ç—ë–ø–ª—ã–π —ç–ø–∏–ª–æ–≥ (100-120 —Å–ª–æ–≤) –∫ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –∫–Ω–∏–≥–µ –æ {full_name}, 
        –ø–æ–¥—ã—Ç–æ–∂–∏–≤–∞—é—â–∏–π –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ —Ä–∞—Å—Å–∫–∞–∑–∞–Ω–æ. –ü—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏,
        –ø–æ–ª–Ω–æ–µ –Ω–∞–¥–µ–∂–¥—ã –∏ –ª—é–±–≤–∏."""
    )
    
    pages.append(f"""
      <div class="page-content text-content epilogue">
        <h2>–≠–ø–∏–ª–æ–≥</h2>
        {markdown.markdown(epilogue)}
        <div class="final-decoration">
          <div class="hearts">üíï ‚ô• üíï</div>
          <p><i>–ö–æ–Ω–µ—Ü ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –Ω–æ–≤–æ–µ –Ω–∞—á–∞–ª–æ...</i></p>
        </div>
      </div>
    """)

    print(f"üìö –°–æ–∑–¥–∞–Ω–æ {len(pages)} —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è —Ñ–ª–∏–ø–±—É–∫–∞")
    return pages


def generate_section_text(role: str, full_name: str, prompt: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ (–ø—Ä–æ–ª–æ–≥, —ç–ø–∏–ª–æ–≥)"""
    try:
        return generate_text(
            prompt=prompt,
            max_tokens=800,
            temperature=0.9
        )
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ {role}: {e}")
        print(f"üìù –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ç–µ–∫—Å—Ç –¥–ª—è {role}")
        
        # –ö—Ä–∞—Å–∏–≤—ã–µ fallback —Ç–µ–∫—Å—Ç—ã
        if role == "–ü—Ä–æ–ª–æ–≥":
            return f"""–≠—Ç–∞ –∫–Ω–∏–≥–∞ ‚Äî –æ {full_name}, –æ –º–æ–º–µ–Ω—Ç–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –∂–∏–∑–Ω—å –æ—Å–æ–±–µ–Ω–Ω–æ–π. 
            
            –í –∫–∞–∂–¥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∂–∏–≤—ë—Ç –∏—Å—Ç–æ—Ä–∏—è, –≤ –∫–∞–∂–¥–æ–º –≤–∑–≥–ª—è–¥–µ ‚Äî —á–∞—Å—Ç–∏—á–∫–∞ –¥—É—à–∏. –ú—ã —Å–æ–±—Ä–∞–ª–∏ –∑–¥–µ—Å—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–∞–¥—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏, –∞ –º–≥–Ω–æ–≤–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –Ω–∞–≤—Å–µ–≥–¥–∞.
            
            –õ–∏—Å—Ç–∞—è —ç—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Ç—ã —É–≤–∏–¥–∏—à—å –Ω–µ —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Å–∏–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, –Ω–æ –∏ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —Ç—É —ç–Ω–µ—Ä–≥–∏—é, —Ç—É —Ä–∞–¥–æ—Å—Ç—å –∏ —Ç—É –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é {full_name} –¥–∞—Ä–∏—Ç –º–∏—Ä—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.
            
            –≠—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –æ —Ç–æ–º, –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –æ—Å–æ–±–µ–Ω–Ω—ã–º–∏, –∫–æ–≥–¥–∞ –∏—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –æ—Å–æ–±–µ–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ–∫."""
            
        elif role == "–≠–ø–∏–ª–æ–≥":
            return f"""–ò—Å—Ç–æ—Ä–∏—è {full_name} –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. 
            
            –≠—Ç–∞ –∫–Ω–∏–≥–∞ ‚Äî –ª–∏—à—å –Ω–µ–±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –¥–ª–∏–Ω–æ—é –≤ –∂–∏–∑–Ω—å. –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è ‚Äî —ç—Ç–æ –Ω–æ–≤–∞—è –≥–ª–∞–≤–∞, –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.
            
            –ü—É—Å—Ç—å –≤–ø–µ—Ä–µ–¥–∏ –±—É–¥–µ—Ç –º–Ω–æ–≥–æ —è—Ä–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤, –∏—Å–∫—Ä–µ–Ω–Ω–∏—Ö —É–ª—ã–±–æ–∫ –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π. –ü—É—Å—Ç—å –∂–∏–∑–Ω—å –¥–∞—Ä–∏—Ç –Ω–æ–≤—ã–µ –ø–æ–≤–æ–¥—ã –¥–ª—è —Ä–∞–¥–æ—Å—Ç–∏ –∏ –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∫–Ω–∏–≥.
            
            –î–æ –≤—Å—Ç—Ä–µ—á–∏ –≤ –Ω–æ–≤—ã—Ö –≥–ª–∞–≤–∞—Ö —ç—Ç–æ–π —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏!"""
        else:
            return "–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω –æ—Å–æ–±–æ–π –∫—Ä–∞—Å–æ—Ç–æ–π –∏ —Ç–µ–ø–ª–æ–º. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∂–∏–≤—É—Ç –≤ —Å–µ—Ä–¥—Ü–µ –Ω–∞–≤—Å–µ–≥–¥–∞."


def generate_toc_summaries(full_name: str, image_count: int, raw_comments: list) -> list[str]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è"""
    try:
        comments_text = " ".join(raw_comments[:10]) if raw_comments else ""
        prompt = f"""–°–æ–∑–¥–∞–π {min(image_count, 12)} –∫—Ä–∞—Ç–∫–∏—Ö –∏ –ø–æ—ç—Ç–∏—á–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –≥–ª–∞–≤ –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –∫–Ω–∏–≥–∏ –æ {full_name}.
        –ö–∞–∂–¥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ì–ª–∞–≤–∞ X: –ù–∞–∑–≤–∞–Ω–∏–µ" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ì–ª–∞–≤–∞ 1: –£—Ç—Ä–µ–Ω–Ω–∏–π —Å–≤–µ—Ç").
        –ù–∞–∑–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ã–º–∏, –Ω–æ –Ω–µ –±–∞–Ω–∞–ª—å–Ω—ã–º–∏. –û—Å–Ω–æ–≤—ã–≤–∞–π—Å—è –Ω–∞ —ç—Ç–∏—Ö –ø–æ–¥–ø–∏—Å—è—Ö –∏–∑ Instagram: {comments_text[:500]}
        
        –í—ã–¥–∞–π —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É."""
        
        result = generate_text(prompt, max_tokens=600, temperature=0.8)
        lines = [line.strip() for line in result.split('\n') if line.strip() and '–ì–ª–∞–≤–∞' in line]
        
        # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –º–µ–Ω—å—à–µ –Ω–∞–∑–≤–∞–Ω–∏–π, —á–µ–º –Ω—É–∂–Ω–æ, –¥–æ–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏
        while len(lines) < min(image_count, 12):
            chapter_num = len(lines) + 1
            lines.append(f"–ì–ª–∞–≤–∞ {chapter_num}: –û—Å–æ–±–µ–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç")
            
        return lines[:min(image_count, 12)]
        
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—è: {e}")
        print("üìù –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ")
        
        # –ö—Ä–∞—Å–∏–≤—ã–µ fallback –Ω–∞–∑–≤–∞–Ω–∏—è –≥–ª–∞–≤
        beautiful_titles = [
            "–ü–µ—Ä–≤—ã–π –≤–∑–≥–ª—è–¥", "–£—Ç—Ä–µ–Ω–Ω–∏–π —Å–≤–µ—Ç", "–ú–æ–º–µ–Ω—Ç—ã —Å—á–∞—Å—Ç—å—è", "–¢—ë–ø–ª—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è",
            "–ò—Å–∫—Ä–µ–Ω–Ω—è—è —É–ª—ã–±–∫–∞", "–Ø—Ä–∫–∏–µ –∫—Ä–∞—Å–∫–∏", "–õ–µ—Ç–Ω–∏–π –¥–µ–Ω—å", "–í–µ—á–µ—Ä–Ω–∏–µ –º–µ—á—Ç—ã",
            "–û—Å–æ–±–µ–Ω–Ω—ã–µ –º–≥–Ω–æ–≤–µ–Ω–∏—è", "–†–∞–¥–æ—Å—Ç–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è", "–î—É—à–µ–≤–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—è", "–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏"
        ]
        
        needed_count = min(image_count, 12)
        result = []
        for i in range(needed_count):
            title = beautiful_titles[i % len(beautiful_titles)]
            result.append(f"–ì–ª–∞–≤–∞ {i+1}: {title}")
        
        return result


def build_flipbook_html(run_id: str, pages: list[str]):
    """–°–æ–±–∏—Ä–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π HTML —Ñ–ª–∏–ø–±—É–∫–∞"""
    try:
        tpl = env.get_template('flipbook_template.html')
        html = tpl.render(pages=pages, run_id=run_id)
        out = Path('data') / run_id / 'book.html'
        out.parent.mkdir(parents=True, exist_ok=True)
        out.write_text(html, encoding='utf-8')
        print(f"‚úÖ Flipbook HTML —Å–æ–∑–¥–∞–Ω: {out}")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ HTML: {e}")
        raise 