import base64
from pathlib import Path
from app.config import settings
from typing import Optional
import logging
import random
from openai import OpenAI

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Azure OpenAI
client = OpenAI(
    api_key=settings.AZURE_OPENAI_API_KEY,
    base_url=settings.AZURE_OPENAI_ENDPOINT,
    default_headers={"api-key": settings.AZURE_OPENAI_API_KEY}
)

logger = logging.getLogger(__name__)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏—à–µ
CLICHE_FILTERS = [
    "–º—è–≥–∫–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏", "—Ä–µ–∑–∫–∏–µ —Ç–µ–Ω–∏", "–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞", "–æ—â—É—â–µ–Ω–∏–µ",
    "–ø–µ—Ä–µ–¥–∞–µ—Ç —ç–º–æ—Ü–∏–∏", "–ø—Ä–∏–¥–∞–µ—Ç –≥–ª—É–±–∏–Ω—É", "—Å–æ–∑–¥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ",
    "–æ—Å–æ–±–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞", "—É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è", "—Å–Ω–∏–º–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç"
]

def strip_cliches(text: str) -> str:
    """–£–±–∏—Ä–∞–µ—Ç —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    for cliche in CLICHE_FILTERS:
        text = text.replace(cliche, "")
    
    # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace("**", "")  # –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = text.replace("***", "")  # –ñ–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤
    text = text.replace("*", "")   # –ö—É—Ä—Å–∏–≤/–≤—ã–¥–µ–ª–µ–Ω–∏–µ
    text = text.replace("__", "")  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∂–∏—Ä–Ω—ã–π
    text = text.replace("_", "")   # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å–∏–≤
    text = text.replace("~~", "")  # –ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
    text = text.replace("```", "") # –ë–ª–æ–∫–∏ –∫–æ–¥–∞
    text = text.replace("`", "")   # –ò–Ω–ª–∞–π–Ω –∫–æ–¥
    text = text.replace("##", "")  # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    text = text.replace("#", "")   # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
    text = text.replace("---", "")  # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    text = text.replace("‚Äì", "-")   # –î–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ –Ω–∞ –æ–±—ã—á–Ω–æ–µ
    text = text.replace("‚Äî", "-")   # –ï—â–µ –¥–ª–∏–Ω–Ω–µ–µ —Ç–∏—Ä–µ
    
    # –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã
    text = " ".join(text.split())
    return text

def generate_text(prompt: str,
                  model: str = "gpt-4o",
                  max_tokens: int = 400,  # –°–Ω–∏–∂–µ–Ω–æ —Å 1500 –¥–æ 400 –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                  temperature: float = 0.7,  # –°–Ω–∏–∂–µ–Ω–æ —Å 0.8 –¥–æ 0.7 –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                  image_data: Optional[str] = None) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é Azure OpenAI API (—Ç–æ–ª—å–∫–æ GPT-4o), —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    try:
        # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o deployment
        deployment = settings.AZURE_OPENAI_GPT4_DEPLOYMENT
        
        # –ë–´–°–¢–†–ê–Ø —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫–∞ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        fast_system_message = """–¢—ã - —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ, –∏—Å–∫—Ä–µ–Ω–Ω–µ, —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ.

–°–¢–ò–õ–¨: –î–Ω–µ–≤–Ω–∏–∫ –≤–ª—é–±–ª–µ–Ω–Ω–æ–≥–æ
–Ø–ó–´–ö: –†—É—Å—Å–∫–∏–π, –ø—Ä–æ—Å—Ç–æ–π, —Ç–µ–ø–ª—ã–π
–î–õ–ò–ù–ê: –ö—Ä–∞—Ç–∫–æ, –ø–æ —Å—É—Ç–∏

–ó–ê–ü–†–ï–©–ï–ù–û: "–ù–µ –º–æ–≥—É –ø–æ–≤–µ—Ä–∏—Ç—å!", "–ü–æ—Ç—Ä—è—Å–∞—é—â–µ!", —Å–ª–æ–∂–Ω—ã–µ —Ñ—Ä–∞–∑—ã"""

        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º vision model
        if image_data:
            messages = [
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": image_data,
                                "detail": "low"  # –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∏–∑–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
                            }
                        }
                    ]
                }
            ]

            response = client.chat.completions.create(
                model=deployment,
                messages=messages,
                max_tokens=max_tokens,
                temperature=temperature
            )
            
        else:
            # –û–±—ã—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (–ë–´–°–¢–†–ê–Ø)
            response = client.chat.completions.create(
                model=deployment,
                messages=[
                    {"role": "system", "content": fast_system_message},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=max_tokens,
                temperature=temperature,
                presence_penalty=0.3,  # –°–Ω–∏–∂–µ–Ω–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                frequency_penalty=0.2  # –°–Ω–∏–∂–µ–Ω–æ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
            )
        
        result = response.choices[0].message.content.strip()
        return strip_cliches(result)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ generate_text: {e}")
        # –ë—ã—Å—Ç—Ä—ã–π fallback –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
        return f"–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω –æ—Å–æ–±–æ–π –∫—Ä–∞—Å–æ—Ç–æ–π –∏ —Ç–µ–ø–ª–æ–º. –ö–∞–∂–¥–∞—è –¥–µ—Ç–∞–ª—å –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–≤–æ–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏."


def analyze_photo_for_memoir(image_path: Path, context: str = "", chapter_focus: str = "general") -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –º–µ–º—É–∞—Ä–Ω–æ–≥–æ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è"""
    try:
        if not image_path.exists():
            return "–í –ø–∞–º—è—Ç–∏ –æ—Å—Ç–∞–ª—Å—è –ª–∏—à—å —Ä–∞–∑–º—ã—Ç—ã–π —Å–∏–ª—É—ç—Ç..."
            
        with open(image_path, "rb") as image_file:
            image_data = base64.b64encode(image_file.read()).decode('utf-8')
        
        # –§–æ–∫—É—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥–ª–∞–≤
        chapter_styles = {
            "first_impression": """–û–ø–∏—à–∏ –ü–ï–†–í–û–ï –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–∞–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ:

–í–∫–ª—é—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ß—Ç–æ –ø–µ—Ä–≤—ã–º –±—Ä–æ—Å–∏–ª–æ—Å—å –≤ –≥–ª–∞–∑–∞ (—Ü–≤–µ—Ç, —Å–≤–µ—Ç, –¥–µ—Ç–∞–ª—å)
- –ö–∞–∫–æ–π –∑–≤—É–∫/–∑–∞–ø–∞—Ö/–æ—â—É—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –≤ –≥–æ–ª–æ–≤—É
- –û–¥–Ω—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ä–µ–ø–ª–∏–∫—É –≤ –∫–∞–≤—ã—á–∫–∞—Ö
- –û–¥–Ω—É –º–µ—Ç–∞—Ñ–æ—Ä—É

–ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ.
–ú–∞–∫—Å–∏–º—É–º 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.""",

            "story_creation": """–°–æ–∑–¥–∞–π –º–∏–Ω–∏-–Ω–æ–≤–µ–ª–ª—É –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 –∞–±–∑–∞—Ü–µ–≤):

1-–π –∞–±–∑–∞—Ü: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –î–û —ç—Ç–æ–≥–æ –∫–∞–¥—Ä–∞
2-–π –∞–±–∑–∞—Ü: –ú–æ–º–µ–Ω—Ç —Å—ä—ë–º–∫–∏ (–≤–∫–ª—é—á–∏ 3 —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ –¥–µ—Ç–∞–ª–∏)
3-–π –∞–±–∑–∞—Ü: –ß—Ç–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —á–µ–ª–æ–≤–µ–∫ –ü–û–°–õ–ï

–ü–∏—à–∏ –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –±—ã–ª —Å–≤–∏–¥–µ—Ç–µ–ª–µ–º —ç—Ç–æ–π —Å—Ü–µ–Ω—ã.
–í–∫–ª—é—á–∏ –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–æ–Ω–æ–ª–æ–≥.""",

            "hidden_emotions": """–ü—Ä–æ—á–∏—Ç–∞–π –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:

–ß—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ –∏–¥–µ–∞–ª—å–Ω—ã–º –∫–∞–¥—Ä–æ–º?
- –ö–∞–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±—ã–ª–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ?
- –û —á—ë–º –¥—É–º–∞–ª —á–µ–ª–æ–≤–µ–∫ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?
- –ß—Ç–æ –æ–Ω –ù–ï –ø–æ–∫–∞–∑–∞–ª –≤ –∫–∞–¥—Ä–µ?

–ü–∏—à–∏ –ª–∏—Ä–∏—á–µ—Å–∫–∏, –≤–∫–ª—é—á–∏ 2-3 —á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.
–ö–∞–∫ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç."""
        }
        
        style = chapter_styles.get(chapter_focus, chapter_styles["first_impression"])
        
        prompt = f"""{style}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è: {context}

–ü–∏—à–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ –∏ –ø–æ—ç—Ç–∏—á–Ω–æ, –Ω–æ –∏—Å–∫—Ä–µ–Ω–Ω–µ.
–ò–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ!"""

        response = client.chat.completions.create(
            model=settings.AZURE_OPENAI_GPT4_DEPLOYMENT,
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_data}",
                                "detail": "high"
                            }
                        }
                    ]
                }
            ],
            max_tokens=300,
            temperature=0.9
        )
        
        result = response.choices[0].message.content.strip()
        return strip_cliches(result)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ {image_path}: {e}")
        return f"–ü–∞–º—è—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞ –ª–∏—à—å –æ—â—É—â–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –∏ —Ç–µ–ø–ª–∞..."


def generate_memoir_chapter(chapter_type: str, data: dict, photo_analysis: str = "") -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–ª–∞–≤—É –º–µ–º—É–∞—Ä–æ–≤ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –≤ –¥–∞–Ω–Ω—ã—Ö
    if chapter_type == "romantic_book_chapter" and "prompt" in data:
        # –î–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –∫–Ω–∏–≥ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt = data["prompt"]
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: —Å–æ–∫—Ä–∞—â–∞–µ–º –≤—Å–µ –ø—Ä–æ–º–ø—Ç—ã –≤ 3-4 —Ä–∞–∑–∞
        # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if len(prompt) > 500:
            # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü –ø–µ—Ä–≤–æ–≥–æ –∞–±–∑–∞—Ü–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
            cut_point = prompt.find("–°–¢–†–£–ö–¢–£–†–ê –ì–õ–ê–í–´:")
            if cut_point > 0:
                prompt = prompt[:cut_point] + "\n\n–ù–∞–ø–∏—à–∏ 3-4 –∞–±–∑–∞—Ü–∞ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ –∏ –ª–∏—á–Ω–æ."
            else:
                prompt = prompt[:500] + "... –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ."
        
        result = generate_text(prompt, max_tokens=400, temperature=0.7)  # –°–Ω–∏–∂–µ–Ω–æ —Å 1500 –¥–æ 400
        return strip_cliches(result)
    
    username = data.get('username', '–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü')
    followers = data.get('followers', 0)
    captions = data.get('captions', ['–ë–µ–∑ —Å–ª–æ–≤'])
    bio = data.get('bio', '')
    locations = data.get('locations', ['–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ'])
    
    # –ë–´–°–¢–†–´–ï –ö–û–†–û–¢–ö–ò–ï –ü–†–û–ú–ü–¢–´ –≤–º–µ—Å—Ç–æ –¥–ª–∏–Ω–Ω—ã—Ö
    quick_prompts = {
        "meeting": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–µ —Å @{username}:

1. "–î–æ—Ä–æ–≥–æ–π {username}, –ª–∏—Å—Ç–∞—è Instagram, —è —É–≤–∏–¥–µ–ª —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å..."
2. –ß—Ç–æ –∑–∞—Ü–µ–ø–∏–ª–æ —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞
3. –ü–æ—á–µ–º—É –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –∏–∑—É—á–∞—Ç—å –¥–∞–ª—å—à–µ

–ü–∏—à–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞. –ü–æ–¥–ø–∏—Å—å: "{captions[0] if captions else '—Ç–≤–æ—è –ø–æ–¥–ø–∏—Å—å'}"

–ú–∞–∫—Å–∏–º—É–º 300 —Å–ª–æ–≤.""",

        "first_impression": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –ø–µ—Ä–≤—ã—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è—Ö –æ—Ç @{username}:

1. "–ß—Ç–æ –º–µ–Ω—è –ø–æ—Ä–∞–∑–∏–ª–æ –≤ —Ç–≤–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ..."
2. –û–ø–∏—Å–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ - –≥–ª–∞–∑–∞, —É–ª—ã–±–∫–∞, —á–µ—Ä—Ç—ã –ª–∏—Ü–∞  
3. –û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ–± –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç–∏

–°—Ç–∏–ª—å: —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ, –ª–∏—á–Ω–æ. –ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "world_view": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ —Ç–æ–º, –∫–∞–∫ @{username} –≤–∏–¥–∏—Ç –º–∏—Ä:

1. "–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Ä–∞–∂–∞–µ—Ç, –∫–∞–∫ —Ç—ã –≤–∏–¥–∏—à—å –º–∏—Ä..."
2. –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
3. –°–≤—è–∑—å –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –º–∏—Ä–∞

–ë–ò–û: "{bio if bio else '–ú–æ–ª—á–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç –æ –º–Ω–æ–≥–æ–º'}"
–ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "memorable_moments": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –∑–∞–ø–æ–º–Ω–∏–≤—à–∏—Ö—Å—è –º–æ–º–µ–Ω—Ç–∞—Ö @{username}:

1. "–ï—Å—Ç—å –∫–∞–¥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ä–µ–∑–∞–ª–∏—Å—å –≤ –ø–∞–º—è—Ç—å..."
2. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è
3. –ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å —ç–º–æ—Ü–∏–π –≤ –≥–ª–∞–∑–∞—Ö

–ü–æ–¥–ø–∏—Å—å: "{captions[0] if captions else 'ü§†'}"
–ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "energy": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ–± —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–µ @{username}:

1. "–í —Ç–µ–±–µ –æ—Å–æ–±–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞..."
2. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ —Ö–∞—Ä–∏–∑–º–∞
3. –û–ø–∏—Å–∞–Ω–∏–µ - –∫–æ–∂–∞, –≤–æ–ª–æ—Å—ã, –¥–≤–∏–∂–µ–Ω–∏—è

–°—Ç–∏–ª—å: –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ. –ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "beauty_style": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –∫—Ä–∞—Å–æ—Ç–µ @{username}:

1. "–ö—Ä–∞—Å–æ—Ç–∞ –≤ —Ç–≤–æ–µ–º —Å–ª—É—á–∞–µ –æ—á–µ–≤–∏–¥–Ω–∞..."
2. –õ–∏—Ü–æ –∫–∞–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞
3. –ë—Ä–æ–≤–∏, —Ä–µ—Å–Ω–∏—Ü—ã, —É–ª—ã–±–∫–∞

–°—Ç–∏–ª—å: –ø–æ—ç—Ç–∏—á–Ω–æ. –ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "mystery": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç–∏ @{username}:

1. "–í —Ç–µ–±–µ –æ—Å–æ–±–∞—è –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç—å..."
2. –í–∑–≥–ª—è–¥ –∏ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ –≥–æ–ª–æ—Å–µ
3. –ü–æ—Ö–æ–¥–∫–∞ –∏ –º–∞–Ω–µ—Ä—ã

–°—Ç–∏–ª—å: –∏–Ω—Ç—Ä–∏–≥–∞. –ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "influence_on_me": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –≤–ª–∏—è–Ω–∏–∏ @{username}:

1. "–¢—ã –∏–∑–º–µ–Ω–∏–ª –º–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–Ω–æ–≥–æ–µ..."
2. –ù–æ–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º
3. –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ —É—Ä–æ–∫–∏

–ü–æ–¥–ø–∏—Å—å: "{captions[0] if captions else '—Ç–≤–æ—è –ø–æ–¥–ø–∏—Å—å'}"
–ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "observations": f"""–ù–∞–ø–∏—à–∏ 3 –∞–±–∑–∞—Ü–∞ –æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è—Ö –∑–∞ @{username}:

1. "–°–¥–µ–ª–∞–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è..."
2. –§–æ—Ç–æ–≥–µ–Ω–∏—á–Ω–æ—Å—Ç—å –∏ —Ä—É–∫–∏
3. –õ—é–±–æ–≤—å –∫ —Å–≤–µ—Ç—É –∏ –æ—Å–∞–Ω–∫–∞

–°—Ç–∏–ª—å: –Ω–∞–±–ª—é–¥–µ–Ω–∏—è. –ú–∞–∫—Å–∏–º—É–º 250 —Å–ª–æ–≤.""",

        "gratitude_wishes": f"""–ù–∞–ø–∏—à–∏ 4 –∞–±–∑–∞—Ü–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ {username}:

1. "–ö–Ω–∏–≥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É..."
2. –ü–æ–∂–µ–ª–∞–Ω–∏—è –±—ã—Ç—å —Å–æ–±–æ–π
3. –ü–æ–∂–µ–ª–∞–Ω–∏—è –ª—é–±–≤–∏ –∏ —Å—á–∞—Å—Ç—å—è  
4. "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å. –¢–≤–æ–π –ø–æ–∫–ª–æ–Ω–Ω–∏–∫."

–ë–ò–û: "{bio if bio else '–æ—Å–æ–±–µ–Ω–Ω–∞—è –Ω–∞—Ç—É—Ä–∞'}"
–ú–∞–∫—Å–∏–º—É–º 300 —Å–ª–æ–≤."""
    }
    
    # Fallback –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫ –ò–ò
    fallback_content = {
        "meeting": f"–î–æ—Ä–æ–≥–æ–π {username}, –ª–∏—Å—Ç–∞—è Instagram, —è —Å–ª—É—á–∞–π–Ω–æ –Ω–∞—Ç–∫–Ω—É–ª—Å—è –Ω–∞ —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å. –ß—Ç–æ-—Ç–æ –≤ —Ç–≤–æ–µ–º –≤–∑–≥–ª—è–¥–µ –∑–∞—Å—Ç–∞–≤–∏–ª–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ –∏–∑—É—á–∞—Ç—å –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±—ã–ª–∞ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–æ–π —Ç–∞–∫ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤ –º–∏—Ä–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤.",
        
        "first_impression": f"–ü–µ—Ä–≤–æ–µ, —á—Ç–æ –ø–æ—Ä–∞–∑–∏–ª–æ –≤ —Ç–≤–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ - —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –ö–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é, –∞ —Ç–≤–æ–∏ –≥–ª–∞–∑–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã. –í –Ω–∏—Ö —á–∏—Ç–∞–µ—Ç—Å—è —É–º, –¥–æ–±—Ä–æ—Ç–∞ –∏ –≥–ª—É–±–∏–Ω–∞ –¥—É—à–∏. –¢–≤–æ—è —É–ª—ã–±–∫–∞ –æ—Å–≤–µ—â–∞–µ—Ç –≤—Å–µ –≤–æ–∫—Ä—É–≥.",
        
        "world_view": f"–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Ä–∞–∂–∞–µ—Ç —Ç–æ, –∫–∞–∫ —Ç—ã –≤–∏–¥–∏—à—å –º–∏—Ä –≤–æ–∫—Ä—É–≥ —Å–µ–±—è. –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ –≤ –æ–±—ã–¥–µ–Ω–Ω–æ–º. –¢–≤–æ—è –≤–Ω–µ—à–Ω–æ—Å—Ç—å –æ—Ç—Ä–∞–∂–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–∏—Ä - —Ç—ã –∫—Ä–∞—Å–∏–≤ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫—Ä–∞—Å–æ—Ç–æ–π.",
        
        "memorable_moments": f"–ï—Å—Ç—å –∫–∞–¥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ä–µ–∑–∞–ª–∏—Å—å –≤ –ø–∞–º—è—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞. –¢–≤–æ—è –∫—Ä–∞—Å–æ—Ç–∞ –∂–∏–≤–∞—è, –º–µ–Ω—è—é—â–∞—è—Å—è. –¢–≤–æ–∏ –≥–ª–∞–∑–∞ - –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ—ç–º–∞, –≥–ª—É–±–æ–∫–∏–µ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ. –ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å - —Ç–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ.",
        
        "energy": f"–í —Ç–µ–±–µ –µ—Å—Ç—å –æ—Å–æ–±–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –¥–∞–∂–µ —á–µ—Ä–µ–∑ —ç–∫—Ä–∞–Ω. –£–º–µ–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –£ —Ç–µ–±—è –∫—Ä–∞—Å–∏–≤–∞—è –∫–æ–∂–∞, –≤–æ–ª–æ—Å—ã, –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ–ª–Ω—ã –≥—Ä–∞—Ü–∏–∏.",
        
        "beauty_style": f"–ö—Ä–∞—Å–æ—Ç–∞ –≤ —Ç–≤–æ–µ–º —Å–ª—É—á–∞–µ –æ—á–µ–≤–∏–¥–Ω–∞ –¥–ª—è –≤—Å–µ—Ö. –¢–≤–æ–µ –ª–∏—Ü–æ - –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è–º–∏. –ö—Ä–∞—Å–∏–≤—ã–µ –±—Ä–æ–≤–∏, –¥–ª–∏–Ω–Ω—ã–µ —Ä–µ—Å–Ω–∏—Ü—ã, –±–µ–∑—É–ø—Ä–µ—á–Ω–∞—è –∫–æ–∂–∞.",
        
        "mystery": f"–í —Ç–µ–±–µ –æ—Å–æ–±–∞—è –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –¥–∞–µ—Ç –ø–æ–∫–æ—è. –ö–∞–∂–¥—ã–π –∫–∞–¥—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ. –¢–≤–æ–π –≤–∑–≥–ª—è–¥ –∑–∞–≥–∞–¥–æ—á–µ–Ω, –≤ –Ω–µ–º –≥–ª—É–±–∏–Ω–∞ –æ–∫–µ–∞–Ω–∞.",
        
        "influence_on_me": f"–¢—ã –∏–∑–º–µ–Ω–∏–ª –º–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–Ω–æ–≥–∏–µ –≤–µ—â–∏. –°—Ç–∞–ª –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –æ–±—Ä–∞—â–∞—Ç—å –Ω–∞ –¥–µ—Ç–∞–ª–∏ –≤–æ–∫—Ä—É–≥. –ü–æ–∫–∞–∑–∞–ª, —á—Ç–æ –∫—Ä–∞—Å–æ—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–æ–≥–∏—Ö –¥–µ–∫–æ—Ä–∞—Ü–∏–π.",
        
        "observations": f"–ó–∞ –≤—Ä–µ–º—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —Å–¥–µ–ª–∞–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è. –¢–≤–æ–µ –ª–∏—Ü–æ –æ—á–µ–Ω—å —Ñ–æ—Ç–æ–≥–µ–Ω–∏—á–Ω–æ–µ, –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ä—É–∫–∏. –õ—é–±–∏—à—å —Å–≤–µ—Ç –∏ —É–º–µ–ª–æ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å.",
        
        "gratitude_wishes": f"{username}, —ç—Ç–∞ –∫–Ω–∏–≥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É, –Ω–æ –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∞–π –±—ã—Ç—å —Å–æ–±–æ–π, –∂–µ–ª–∞—é –ª—é–±–≤–∏ –∏ —Å—á–∞—Å—Ç—å—è. –°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å. –¢–≤–æ–π –ø–æ–∫–ª–æ–Ω–Ω–∏–∫."
    }
    
    # –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    try:
        prompt = quick_prompts.get(chapter_type, f"–ù–∞–ø–∏—à–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ –æ {chapter_type.replace('_', ' ')}.")
        result = generate_text(prompt, max_tokens=300, temperature=0.7)  # –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if len(result.strip()) < 50:  # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
            return fallback_content.get(chapter_type, f"–ì–ª–∞–≤–∞ –æ {chapter_type.replace('_', ' ')} –Ω–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–µ–ø–ª–æ–º –∏ –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ–º.")
            
        return strip_cliches(result)
        
    except Exception as e:
        print(f"‚ö° –ë—ã—Å—Ç—Ä—ã–π fallback –¥–ª—è –≥–ª–∞–≤—ã '{chapter_type}': {e}")
        return fallback_content.get(chapter_type, f"–≠—Ç–∞ –≥–ª–∞–≤–∞ –æ {chapter_type.replace('_', ' ')} –Ω–∞–ø–∏—Å–∞–Ω–∞ —Å –æ—Å–æ–±–æ–π –Ω–µ–∂–Ω–æ—Å—Ç—å—é.")


def generate_complete_memoir_book(data: dict, images: list) -> dict:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ 10 –≥–ª–∞–≤ –º–µ–º—É–∞—Ä–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –∫–Ω–∏–≥–∏"""
    
    username = data.get('username', '–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü')
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥–ª–∞–≤
    photo_analyses = []
    if images:
        for i, img_path in enumerate(images[:10]):  # –ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            if img_path.exists():
                try:
                    focus_types = ["first_impression", "story_creation", "hidden_emotions"]
                    focus = focus_types[i % 3]
                    analysis = analyze_photo_for_memoir(img_path, f"@{username}", focus)
                    photo_analyses.append(analysis)
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ {img_path}: {e}")
                    photo_analyses.append("–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –æ—Å–æ–±—ã–µ —á—É–≤—Å—Ç–≤–∞...")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑—ã —Ñ–æ—Ç–æ –≤ –¥–∞–Ω–Ω—ã–µ
    data['photo_analyses'] = photo_analyses
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ 10 –≥–ª–∞–≤
    chapters = {}
    
    chapter_types = [
        "meeting", "first_impression", "world_view", "memorable_moments", 
        "energy", "beauty_style", "mystery", "influence_on_me", 
        "observations", "gratitude_wishes"
    ]
    
    for chapter_type in chapter_types:
        try:
            photo_analysis = ""
            if chapter_type in ["first_impression", "memorable_moments"] and photo_analyses:
                photo_analysis = photo_analyses[0] if photo_analyses else ""
            
            chapter_content = generate_memoir_chapter(chapter_type, data, photo_analysis)
            chapters[chapter_type] = chapter_content
            print(f"‚úÖ –ì–ª–∞–≤–∞ '{chapter_type}' —Å–æ–∑–¥–∞–Ω–∞")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª–∞–≤—ã '{chapter_type}': {e}")
            # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            chapters[chapter_type] = f"–ì–ª–∞–≤–∞ –æ {chapter_type.replace('_', ' ')} –∂–¥–µ—Ç —Å–≤–æ–µ–≥–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—è..."
    
    return chapters
