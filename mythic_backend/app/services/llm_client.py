import base64
from pathlib import Path
from app.config import settings
from typing import Optional
import logging
import random
from openai import AzureOpenAI, AsyncAzureOpenAI
import json
import markdown
from app.services.cache_service import cache_service

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
client = AzureOpenAI(
    api_key=settings.AZURE_OPENAI_API_KEY,
    azure_endpoint=settings.AZURE_OPENAI_ENDPOINT,
    api_version=settings.AZURE_OPENAI_API_VERSION
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ê–°–ò–ù–•–†–û–ù–ù–û–ì–û –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
async_client = AsyncAzureOpenAI(
    api_key=settings.AZURE_OPENAI_API_KEY,
    azure_endpoint=settings.AZURE_OPENAI_ENDPOINT,
    api_version=settings.AZURE_OPENAI_API_VERSION
)

logger = logging.getLogger(__name__)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏—à–µ
CLICHE_FILTERS = [
    "–º—è–≥–∫–∏–µ –æ—Ç—Ç–µ–Ω–∫–∏", "—Ä–µ–∑–∫–∏–µ —Ç–µ–Ω–∏", "–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞", "–æ—â—É—â–µ–Ω–∏–µ",
    "–ø–µ—Ä–µ–¥–∞–µ—Ç —ç–º–æ—Ü–∏–∏", "–ø—Ä–∏–¥–∞–µ—Ç –≥–ª—É–±–∏–Ω—É", "—Å–æ–∑–¥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ",
    "–æ—Å–æ–±–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞", "—É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è", "—Å–Ω–∏–º–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç"
]

def strip_cliches(text: str) -> str:
    """–£–±–∏—Ä–∞–µ—Ç —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    for cliche in CLICHE_FILTERS:
        text = text.replace(cliche, "")
    
    # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace("**", "")  # –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = text.replace("***", "")  # –ñ–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤
    text = text.replace("*", "")   # –ö—É—Ä—Å–∏–≤/–≤—ã–¥–µ–ª–µ–Ω–∏–µ
    text = text.replace("__", "")  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∂–∏—Ä–Ω—ã–π
    text = text.replace("_", "")   # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å–∏–≤
    text = text.replace("~~", "")  # –ó–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
    text = text.replace("```", "") # –ë–ª–æ–∫–∏ –∫–æ–¥–∞
    text = text.replace("`", "")   # –ò–Ω–ª–∞–π–Ω –∫–æ–¥
    text = text.replace("##", "")  # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    text = text.replace("#", "")   # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
    text = text.replace("---", "")  # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    text = text.replace("‚Äì", "-")   # –î–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ –Ω–∞ –æ–±—ã—á–Ω–æ–µ
    text = text.replace("‚Äî", "-")   # –ï—â–µ –¥–ª–∏–Ω–Ω–µ–µ —Ç–∏—Ä–µ
    
    # –£–±–∏—Ä–∞–µ–º –¥–≤–æ–π–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã
    text = " ".join(text.split())
    return text

def image_to_base64(image_path: str) -> str:
    """–ö–æ–¥–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É Base64 —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º MIME-—Ç–∏–ø–æ–º."""
    try:
        with open(image_path, "rb") as image_file:
            encoded_string = base64.b64encode(image_file.read()).decode('utf-8')
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
        extension = Path(image_path).suffix.lower().replace('.', '')
        if extension == 'jpg':
            extension = 'jpeg'
        
        return f"data:image/{extension};base64,{encoded_string}"
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {image_path}: {e}")
        return ""

async def generate_flipbook_json(image_paths: list[str]) -> dict:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–ª–∏–ø–±—É–∫–∞ (–ø—Ä–æ–ª–æ–≥ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã) –≤ –≤–∏–¥–µ –µ–¥–∏–Ω–æ–≥–æ JSON-–æ–±—ä–µ–∫—Ç–∞,
    –∏—Å–ø–æ–ª—å–∑—É—è function calling –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∞—Ç–∞.
    """
    # 1. –°—Ö–µ–º–∞ –¥–ª—è function calling
    functions = [
        {
            "name": "build_flipbook",
            "description": "–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ñ–ª–∏–ø–±—É–∫–∞: –ø—Ä–æ–ª–æ–≥ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.",
            "parameters": {
                "type": "object",
                "properties": {
                    "prologue": {
                        "type": "string",
                        "description": "–í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–∏–≥–∏, –∑–∞–¥–∞—é—â–∏–π —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ."
                    },
                    "pages": {
                        "type": "array",
                        "description": "–ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–∞–Ω–∏—Ü, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç –∏ –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.",
                        "items": {
                            "type": "object",
                            "properties": {
                                "text": {"type": "string", "description": "–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é."},
                                "image": {"type": "string", "description": "–ò–º—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã."}
                            },
                            "required": ["text", "image"]
                        }
                    }
                },
                "required": ["prologue", "pages"]
            }
        }
    ]

    # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–æ–¥–µ–ª–∏
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç–∏ –≤ –ø—Ä–æ—Å—Ç–æ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç –º–æ–¥–µ–ª—å
    image_filenames = [Path(p).name for p in image_paths]
    
    system_prompt = """–¢—ã ‚Äî –ø–æ—ç—Ç-—Ä–æ–º–∞–Ω—Ç–∏–∫, –º–∞—Å—Ç–µ—Ä –∫—Ä–∞—Å–∏–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–Ω–∏–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏—Ö –∏—Å—Ç–æ—Ä–∏–π.\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≥–µ—Ä–æ—è –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é –≥–ª–∞–≤—É (1-2 –∞–±–∑–∞—Ü–∞, 60-90 —Å–ª–æ–≤),\n–≥–¥–µ —Ñ–æ—Ç–æ ‚Äî –ª–∏—à—å –ø–æ–≤–æ–¥ –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∑–∞ –æ —á–µ–ª–æ–≤–µ–∫–µ: –µ–≥–æ —á—É–≤—Å—Ç–≤–∞—Ö, –º–µ—á—Ç–∞—Ö, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ, –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö, –Ω–∞–¥–µ–∂–¥–∞—Ö.\n–ù–µ –æ–ø–∏—Å—ã–≤–∞–π, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ –±—É–∫–≤–∞–ª—å–Ω–æ!\n–ü–∏—à–∏ —Ç–∞–∫, –±—É–¥—Ç–æ —Ç—ã –≤–ª—é–±–ª—ë–Ω –≤ –≥–µ—Ä–æ—è, –≤–æ—Å—Ö–∏—â–∞–µ—à—å—Å—è –∏–º, –≤–∏–¥–∏—à—å –≤ –Ω—ë–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å.\n–ò—Å–ø–æ–ª—å–∑—É–π –∫—Ä–∞—Å–∏–≤—ã–π, –ø–æ—ç—Ç–∏—á–Ω—ã–π, –æ–±—Ä–∞–∑–Ω—ã–π —è–∑—ã–∫, –º–µ—Ç–∞—Ñ–æ—Ä—ã, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –∞–ª–ª—é–∑–∏–∏.\n–û–±—Ä–∞—â–∞–π—Å—è –∫ –≥–µ—Ä–æ—é –Ω–∞ ¬´—Ç—ã¬ª –∏–ª–∏ –≤–æ –≤—Ç–æ—Ä–æ–º –ª–∏—Ü–µ.\n–ò–∑–±–µ–≥–∞–π –±–∞–Ω–∞–ª—å–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π—Å—è, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–ª–∏—à–µ.\n–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–µ—Ä–Ω–∏ —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `build_flipbook`.\n–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏.\n–ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–≤—è–∑–Ω–æ–π –∏ –≤—ã–∑—ã–≤–∞—Ç—å —Ç—ë–ø–ª—ã–µ —á—É–≤—Å—Ç–≤–∞."""

    user_prompt = f"–°–æ–∑–¥–∞–π —Ñ–æ—Ç–æ–∫–Ω–∏–≥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {json.dumps(image_filenames)}"

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_prompt}
    ]

    # 3. –í—ã–∑—ã–≤–∞–µ–º Azure OpenAI API —Å `function_call`
    try:
        response = await async_client.chat.completions.create(
            model=settings.AZURE_OPENAI_GPT4_DEPLOYMENT, # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ—â–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–∞
            messages=messages,
            functions=functions,
            function_call={"name": "build_flipbook"}, # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é
            temperature=0.8
        )

        # 4. –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
        function_call_args = response.choices[0].message.function_call.arguments
        if function_call_args:
            flipbook_data = json.loads(function_call_args)
            print("‚úÖ LLM —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª JSON –¥–ª—è —Ñ–ª–∏–ø–±—É–∫–∞.")
            
            # –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤
            image_path_map = {Path(p).name: p for p in image_paths}

            # –ó–∞–º–µ–Ω—è–µ–º –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ Base64
            for page in flipbook_data.get("pages", []):
                image_name = page.get("image")
                if image_name in image_path_map:
                    # –ö–æ–¥–∏—Ä—É–µ–º –≤ Base64 –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ src
                    page["image"] = image_to_base64(image_path_map[image_name])
                else:
                    # –ï—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ
                    page["image"] = ""
            
            return flipbook_data
        else:
            logger.error("LLM –Ω–µ –≤–µ—Ä–Ω—É–ª –æ–∂–∏–¥–∞–µ–º—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏.")
            return {}

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ LLM —Å function calling: {e}")
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–∞–¥–∞–ª–æ
        return {"prologue": "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫...", "pages": []}

async def generate_text_async(prompt: str,
                  system_prompt: str | None = None,
                  model: str = "gpt-4.1-mini",
                  max_tokens: int = 1500,
                  temperature: float = 0.8,
                  image_data: Optional[str] = None) -> str:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è generate_text —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –∫—ç—à–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    cache_key_parts = [
        prompt[:100],  # –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞
        system_prompt[:50] if system_prompt else "",
        str(max_tokens),
        str(temperature),
        "image" if image_data else "text"
    ]
    cache_key = "ai_response:" + hash("".join(cache_key_parts))
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫—ç—à–∞
    cached_response = await cache_service.get_ai_response(cache_key)
    if cached_response:
        logger.info(f"üì¶ –ö—ç—à HIT –¥–ª—è AI –æ—Ç–≤–µ—Ç–∞")
        return cached_response
    
    try:
        deployment = settings.AZURE_OPENAI_GPT4_DEPLOYMENT
        # –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        fast_system_message = system_prompt or "–¢—ã ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫. –ü–∏—à–∏ —è—Å–Ω–æ, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –±–µ–∑ –∫–ª–∏—à–µ."
        if image_data:
            messages = [
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": image_data,
                                "detail": "low"
                            }
                        }
                    ]
                }
            ]
            response = await async_client.chat.completions.create(
                model=deployment,
                messages=messages,
                max_tokens=max_tokens,
                temperature=temperature
            )
        else:
            response = await async_client.chat.completions.create(
                model=deployment,
                messages=[
                    {"role": "system", "content": fast_system_message},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=max_tokens,
                temperature=temperature,
                presence_penalty=0.3,
                frequency_penalty=0.2
            )
        result = response.choices[0].message.content
        if not result:
            return ""
        
        final_result = strip_cliches(result.strip())
        
        # –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 1 —á–∞—Å
        await cache_service.cache_ai_response(cache_key, final_result, 3600)
        
        return final_result
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ generate_text_async: {e}")
        return f"–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω –æ—Å–æ–±–æ–π –∫—Ä–∞—Å–æ—Ç–æ–π –∏ —Ç–µ–ø–ª–æ–º. –ö–∞–∂–¥–∞—è –¥–µ—Ç–∞–ª—å –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–≤–æ–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏."

def generate_text(prompt: str,
                  system_prompt: str | None = None,   # <-- add system_prompt param
                  model: str = "gpt-4.1-mini",
                  max_tokens: int = 1500,
                  temperature: float = 0.8,
                  image_data: Optional[str] = None) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é Azure OpenAI API (—Ç–æ–ª—å–∫–æ GPT-4o), —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    try:
        deployment = settings.AZURE_OPENAI_GPT4_DEPLOYMENT
        # –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        fast_system_message = system_prompt or "–¢—ã ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫. –ü–∏—à–∏ —è—Å–Ω–æ, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –±–µ–∑ –∫–ª–∏—à–µ."
        if image_data:
            messages = [
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": image_data,
                                "detail": "low"
                            }
                        }
                    ]
                }
            ]
            response = client.chat.completions.create(
                model=deployment,
                messages=messages,
                max_tokens=max_tokens,
                temperature=temperature
            )
        else:
            response = client.chat.completions.create(
                model=deployment,
                messages=[
                    {"role": "system", "content": fast_system_message},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=max_tokens,
                temperature=temperature,
                presence_penalty=0.3,
                frequency_penalty=0.2
            )
        result = response.choices[0].message.content
        if not result:
            return ""
        return strip_cliches(result.strip())
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ generate_text: {e}")
        return f"–≠—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω –æ—Å–æ–±–æ–π –∫—Ä–∞—Å–æ—Ç–æ–π –∏ —Ç–µ–ø–ª–æ–º. –ö–∞–∂–¥–∞—è –¥–µ—Ç–∞–ª—å –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–≤–æ–µ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏."


def analyze_photo_for_memoir(image_path: Path, context: str = "", chapter_focus: str = "general") -> str:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –º–µ–º—É–∞—Ä–Ω–æ–≥–æ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è"""
    try:
        if not image_path.exists():
            return "–í –ø–∞–º—è—Ç–∏ –æ—Å—Ç–∞–ª—Å—è –ª–∏—à—å —Ä–∞–∑–º—ã—Ç—ã–π —Å–∏–ª—É—ç—Ç..."
            
        with open(image_path, "rb") as image_file:
            image_data = base64.b64encode(image_file.read()).decode('utf-8')
        
        # –§–æ–∫—É—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥–ª–∞–≤
        chapter_styles = {
            "first_impression": """–û–ø–∏—à–∏ –ü–ï–†–í–û–ï –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–∞–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ:

–í–∫–ª—é—á–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- –ß—Ç–æ –ø–µ—Ä–≤—ã–º –±—Ä–æ—Å–∏–ª–æ—Å—å –≤ –≥–ª–∞–∑–∞ (—Ü–≤–µ—Ç, —Å–≤–µ—Ç, –¥–µ—Ç–∞–ª—å)
- –ö–∞–∫–æ–π –∑–≤—É–∫/–∑–∞–ø–∞—Ö/–æ—â—É—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –≤ –≥–æ–ª–æ–≤—É
- –û–¥–Ω—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ä–µ–ø–ª–∏–∫—É –≤ –∫–∞–≤—ã—á–∫–∞—Ö
- –û–¥–Ω—É –º–µ—Ç–∞—Ñ–æ—Ä—É

–ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –∫–∞–∫ –∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ.
–ú–∞–∫—Å–∏–º—É–º 4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.""",

            "story_creation": """–°–æ–∑–¥–∞–π –º–∏–Ω–∏-–Ω–æ–≤–µ–ª–ª—É –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 3 –∞–±–∑–∞—Ü–µ–≤):

1-–π –∞–±–∑–∞—Ü: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –î–û —ç—Ç–æ–≥–æ –∫–∞–¥—Ä–∞
2-–π –∞–±–∑–∞—Ü: –ú–æ–º–µ–Ω—Ç —Å—ä—ë–º–∫–∏ (–≤–∫–ª—é—á–∏ 3 —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ –¥–µ—Ç–∞–ª–∏)
3-–π –∞–±–∑–∞—Ü: –ß—Ç–æ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —á–µ–ª–æ–≤–µ–∫ –ü–û–°–õ–ï

–ü–∏—à–∏ –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –±—ã–ª —Å–≤–∏–¥–µ—Ç–µ–ª–µ–º —ç—Ç–æ–π —Å—Ü–µ–Ω—ã.
–í–∫–ª—é—á–∏ –æ–¥–∏–Ω –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–æ–Ω–æ–ª–æ–≥.""",

            "hidden_emotions": """–ü—Ä–æ—á–∏—Ç–∞–π –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:

–ß—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∑–∞ –∏–¥–µ–∞–ª—å–Ω—ã–º –∫–∞–¥—Ä–æ–º?
- –ö–∞–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±—ã–ª–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ?
- –û —á—ë–º –¥—É–º–∞–ª —á–µ–ª–æ–≤–µ–∫ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç?
- –ß—Ç–æ –æ–Ω –ù–ï –ø–æ–∫–∞–∑–∞–ª –≤ –∫–∞–¥—Ä–µ?

–ü–∏—à–∏ –ª–∏—Ä–∏—á–µ—Å–∫–∏, –≤–∫–ª—é—á–∏ 2-3 —á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.
–ö–∞–∫ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç."""
        }
        
        style = chapter_styles.get(chapter_focus, chapter_styles["first_impression"])
        
        prompt = f"""{style}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è: {context}

–ü–∏—à–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ –∏ –ø–æ—ç—Ç–∏—á–Ω–æ, –Ω–æ –∏—Å–∫—Ä–µ–Ω–Ω–µ.
–ò–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ!"""

        response = client.chat.completions.create(
            model=settings.AZURE_OPENAI_GPT4_DEPLOYMENT,
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{image_data}",
                                "detail": "high"
                            }
                        }
                    ]
                }
            ],
            max_tokens=300,
            temperature=0.9
        )
        
        result = response.choices[0].message.content.strip()
        return strip_cliches(result)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ {image_path}: {e}")
        return f"–ü–∞–º—è—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞ –ª–∏—à—å –æ—â—É—â–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –∏ —Ç–µ–ø–ª–∞..."


def generate_memoir_chapter(chapter_type: str, data: dict, photo_analysis: str = "", temperature: float = 0.8, max_tokens: int = 1200) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–ª–∞–≤—É –º–µ–º—É–∞—Ä–æ–≤ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –≤ –¥–∞–Ω–Ω—ã—Ö
    if chapter_type == "romantic_book_chapter" and "prompt" in data:
        # –î–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –∫–Ω–∏–≥ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        prompt = data["prompt"]
        
        # –ù–ï –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —Å –ø–æ—Å–ª–æ–≤–∏—Ü–∞–º–∏ - –æ–Ω–∏ —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
        result = generate_text(prompt, max_tokens=max_tokens, temperature=temperature)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
        return strip_cliches(result)
    
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ—ç–Ω—Ç–µ–∑–∏ —Å—Ç–∏–ª—è
    if chapter_type == "fantasy_chapter" and "prompt" in data:
        prompt = data["prompt"]
        sys_prompt = data.get("system_prompt")  # <-- extract system_prompt if present
        
        # –ù–ï –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–º–ø—Ç—ã —Å –ø–æ—Å–ª–æ–≤–∏—Ü–∞–º–∏ - –æ–Ω–∏ —É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
        result = generate_text(
            prompt, 
            system_prompt=sys_prompt,            # <-- pass system_prompt
            max_tokens=max_tokens, 
            temperature=temperature
        )  # –ë–æ–ª—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è —Ñ—ç–Ω—Ç–µ–∑–∏
        return strip_cliches(result)
    
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è
    if chapter_type == "humor_chapter" and "prompt" in data:
        prompt = data["prompt"]
        sys_prompt = data.get("system_prompt")  # <-- extract system_prompt if present
        result = generate_text(
            prompt,
            system_prompt=sys_prompt,            # <-- pass system_prompt
            max_tokens=max_tokens,
            temperature=temperature
        )
        return strip_cliches(result)
    
    username = data.get('username', '–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü')
    followers = data.get('followers', 0)
    captions = data.get('captions', ['–ë–µ–∑ —Å–ª–æ–≤'])
    bio = data.get('bio', '')
    locations = data.get('locations', ['–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ'])
    
    # –£–ª—É—á—à–µ–Ω–Ω—ã–µ –î–õ–ò–ù–ù–´–ï –ü–†–û–ú–ü–¢–´ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
    detailed_prompts = {
        "meeting": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–µ —Å @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–î–æ—Ä–æ–≥–æ–π {username}, –ª–∏—Å—Ç–∞—è Instagram, —è —É–≤–∏–¥–µ–ª —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å..." - –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ
2. –ü–µ—Ä–≤–∞—è —Ä–µ–∞–∫—Ü–∏—è - —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞—Ü–µ–ø–∏–ª–æ —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∑–≥–ª—è–¥–∞
3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –∑–∞—Å—Ç–∞–≤–∏–ª–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
4. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–æ–Ω–æ–ª–æ–≥ –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫ –æ—Å–æ–±–µ–Ω–Ω—ã–π
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ä–µ—à–µ–Ω–∏–∏ –∏–∑—É—á–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –¥–∞–ª—å—à–µ

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –ø–æ–¥–ø–∏—Å–∏ "{captions[0] if captions else '—Ç–≤–æ—è –ø–æ–¥–ø–∏—Å—å'}", {followers} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

–ü–∏—à–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞, –¥–µ—Ç–∞–ª—å–Ω–æ. –ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "first_impression": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –ø–µ—Ä–≤—ã—Ö –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è—Ö –æ—Ç @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–ß—Ç–æ –º–µ–Ω—è –ø–æ—Ä–∞–∑–∏–ª–æ –≤ —Ç–≤–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ..." - –æ–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ
2. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ - –≥–ª–∞–∑–∞, –∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, —Ü–≤–µ—Ç, –≥–ª—É–±–∏–Ω–∞
3. –£–ª—ã–±–∫–∞, —á–µ—Ä—Ç—ã –ª–∏—Ü–∞, –æ–±—â–∞—è –≥–∞—Ä–º–æ–Ω–∏—è
4. –í–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ–± –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–æ—Ç–∞, –∞ —á—Ç–æ-—Ç–æ –±–æ–ª—å—à–µ–µ

–°—Ç–∏–ª—å: —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ, –ª–∏—á–Ω–æ, –ø–æ—ç—Ç–∏—á–Ω–æ. –ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "world_view": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ —Ç–æ–º, –∫–∞–∫ @{username} –≤–∏–¥–∏—Ç –º–∏—Ä (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Ä–∞–∂–∞–µ—Ç, –∫–∞–∫ —Ç—ã –≤–∏–¥–∏—à—å –º–∏—Ä –≤–æ–∫—Ä—É–≥ —Å–µ–±—è..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –ê–Ω–∞–ª–∏–∑ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏ –≤—ã–±–æ—Ä–∞ —Ä–∞–∫—É—Ä—Å–æ–≤
3. –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—å –∫—Ä–∞—Å–æ—Ç—É –≤ –æ–±—ã—á–Ω–æ–º
4. –°–≤—è–∑—å –º–µ–∂–¥—É –≤–Ω–µ—à–Ω–æ—Å—Ç—å—é –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –º–∏—Ä–æ–º
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫—Ä–∞—Å–æ—Ç–∞ –¥—É—à–∏ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –æ–±–ª–∏–∫–µ

–ë–ò–û: "{bio if bio else '–ú–æ–ª—á–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç –æ –º–Ω–æ–≥–æ–º'}"
–õ–æ–∫–∞—Ü–∏–∏: {', '.join(locations[:3])}

–ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "memorable_moments": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –∑–∞–ø–æ–º–Ω–∏–≤—à–∏—Ö—Å—è –º–æ–º–µ–Ω—Ç–∞—Ö @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–ï—Å—Ç—å –∫–∞–¥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ä–µ–∑–∞–ª–∏—Å—å –≤ –ø–∞–º—è—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–π –æ—Ç –Ω–µ—ë
3. –ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π –≤ –≥–ª–∞–∑–∞—Ö –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ –ª–∏—Ü–∞
4. –ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –∂–∏–≤–æ—Å—Ç—å –∫—Ä–∞—Å–æ—Ç—ã
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä - –æ—Ç–¥–µ–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è

–ü–æ–¥–ø–∏—Å—å: "{captions[0] if captions else 'ü§†'}"

–ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "energy": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ–± —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–µ @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–í —Ç–µ–±–µ –µ—Å—Ç—å –æ—Å–æ–±–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –û–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∏–∑–º—ã –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ - –∫–æ–∂–∞, –µ—ë —Å–∏—è–Ω–∏–µ, —Ç–µ–∫—Å—Ç—É—Ä–∞
4. –í–æ–ª–æ—Å—ã, –∏—Ö –∫—Ä–∞—Å–æ—Ç–∞ –∏ —É—Ö–æ–∂–µ–Ω–Ω–æ—Å—Ç—å
5. –î–≤–∏–∂–µ–Ω–∏—è, –≥—Ä–∞—Ü–∏—è, –º–∞–Ω–µ—Ä–∞ –¥–µ—Ä–∂–∞—Ç—å—Å—è

–°—Ç–∏–ª—å: –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ, –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å. –ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "beauty_style": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –∫—Ä–∞—Å–æ—Ç–µ @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–ö—Ä–∞—Å–æ—Ç–∞ –≤ —Ç–≤–æ–µ–º —Å–ª—É—á–∞–µ –æ—á–µ–≤–∏–¥–Ω–∞ –¥–ª—è –≤—Å–µ—Ö..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –õ–∏—Ü–æ –∫–∞–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞ - –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –≥–∞—Ä–º–æ–Ω–∏—è
3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –±—Ä–æ–≤–∏, –∏—Ö —Ñ–æ—Ä–º–∞ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4. –†–µ—Å–Ω–∏—Ü—ã, –∏—Ö –¥–ª–∏–Ω–∞ –∏ –∫—Ä–∞—Å–æ—Ç–∞, –≤–∑–≥–ª—è–¥
5. –ö–æ–∂–∞, –µ—ë –±–µ–∑—É–ø—Ä–µ—á–Ω–æ—Å—Ç—å –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–∏—è–Ω–∏–µ

–°—Ç–∏–ª—å: –ø–æ—ç—Ç–∏—á–Ω–æ, –≤–æ—Å—Ö–∏—â–µ–Ω–Ω–æ. –ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "mystery": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç–∏ @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–í —Ç–µ–±–µ –µ—Å—Ç—å –æ—Å–æ–±–∞—è –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç—å..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –ê–Ω–∞–ª–∏–∑ –≤–∑–≥–ª—è–¥–∞ - –µ–≥–æ –≥–ª—É–±–∏–Ω–∞ –∏ —Ç–∞–π–Ω—ã
3. –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ –≥–æ–ª–æ—Å–µ, –µ–≥–æ —Ç–µ–º–±—Ä–µ –∏ –º–µ–ª–æ–¥–∏—á–Ω–æ—Å—Ç–∏
4. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ –ø–æ—Ö–æ–¥–∫–µ, –≥—Ä–∞—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏–π
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∑–∞–≥–∞–¥–∫–∞ –¥–µ–ª–∞–µ—Ç –µ—â—ë –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–µ–µ

–°—Ç–∏–ª—å: –∏–Ω—Ç—Ä–∏–≥–∞, —Ä–æ–º–∞–Ω—Ç–∏–∫–∞. –ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "influence_on_me": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –≤–ª–∏—è–Ω–∏–∏ @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–¢—ã –∏–∑–º–µ–Ω–∏–ª –º–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–Ω–æ–≥–∏–µ –≤–µ—â–∏..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –ù–æ–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥–µ—Ç–∞–ª—è–º - —Å–≤–µ—Ç, —Ç–µ–Ω–∏, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è
3. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –∫—Ä–∞—Å–æ—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–∫–æ—Ä–∞—Ü–∏–π
4. –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ —É—Ä–æ–∫ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç–∏
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –æ —Ç–æ–º, –∫–∞–∫ —ç—Ç–æ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ

–ü–æ–¥–ø–∏—Å—å: "{captions[0] if captions else '—Ç–≤–æ—è –ø–æ–¥–ø–∏—Å—å'}"

–ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "observations": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –≥–ª–∞–≤—É –æ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è—Ö –∑–∞ @{username} (4-5 –∞–±–∑–∞—Ü–µ–≤):

1. "–ó–∞ –≤—Ä–µ–º—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —Å–¥–µ–ª–∞–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –§–æ—Ç–æ–≥–µ–Ω–∏—á–Ω–æ—Å—Ç—å - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–ª–æ—Ö–∏—Ö —Ä–∞–∫—É—Ä—Å–æ–≤
3. –í—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ä—É–∫–∏, –∏—Ö –∫—Ä–∞—Å–æ—Ç–∞ –∏ –≥—Ä–∞—Ü–∏—è
4. –õ—é–±–æ–≤—å –∫ —Å–≤–µ—Ç—É –∏ —É–º–µ–Ω–∏–µ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
5. –û—Å–∞–Ω–∫–∞, –º–∞–Ω–µ—Ä–∞ –¥–µ—Ä–∂–∞—Ç—å—Å—è, –æ–±—â–∞—è —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å

–°—Ç–∏–ª—å: –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ. –ú–∏–Ω–∏–º—É–º 400 —Å–ª–æ–≤.""",

        "gratitude_wishes": f"""–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—É—é –≥–ª–∞–≤—É –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ {username} (5-6 –∞–±–∑–∞—Ü–µ–≤):

1. "{username}, —ç—Ç–∞ –∫–Ω–∏–≥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É..." - –≤–≤–µ–¥–µ–Ω–∏–µ
2. –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –∏ –∫—Ä–∞—Å–æ—Ç—É
3. –ü–æ–∂–µ–ª–∞–Ω–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –±—ã—Ç—å —Å–æ–±–æ–π
4. –ü–æ–∂–µ–ª–∞–Ω–∏—è –ª—é–±–≤–∏, —Å—á–∞—Å—Ç—å—è –∏ —è—Ä–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤
5. –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∑–∞ —Ç–æ, —á—Ç–æ —Ç–∞–∫–∏–µ –ª—é–¥–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
6. "–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å. –¢–≤–æ–π –ø–æ–∫–ª–æ–Ω–Ω–∏–∫." - –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

–ë–ò–û: "{bio if bio else '–æ—Å–æ–±–µ–Ω–Ω–∞—è –Ω–∞—Ç—É—Ä–∞'}"

–ú–∏–Ω–∏–º—É–º 500 —Å–ª–æ–≤."""
    }
    
    # Fallback –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ—Ç –∂–µ
    fallback_content = {
        "meeting": f"–î–æ—Ä–æ–≥–æ–π {username}, –ª–∏—Å—Ç–∞—è Instagram, —è —Å–ª—É—á–∞–π–Ω–æ –Ω–∞—Ç–∫–Ω—É–ª—Å—è –Ω–∞ —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å. –ß—Ç–æ-—Ç–æ –≤ —Ç–≤–æ–µ–º –≤–∑–≥–ª—è–¥–µ –∑–∞—Å—Ç–∞–≤–∏–ª–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ –∏–∑—É—á–∞—Ç—å –∫–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±—ã–ª–∞ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–æ–π —Ç–∞–∫ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤ –º–∏—Ä–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤. –¢—ã –ø–æ–∫–∞–∑–∞–ª—Å—è –º–Ω–µ –æ—Å–æ–±–µ–Ω–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.",
        
        "first_impression": f"–ü–µ—Ä–≤–æ–µ, —á—Ç–æ –ø–æ—Ä–∞–∑–∏–ª–æ –≤ —Ç–≤–æ–µ–º –ø—Ä–æ—Ñ–∏–ª–µ - —ç—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å. –ö–∞–∂–¥–æ–µ —Ñ–æ—Ç–æ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é, –∞ —Ç–≤–æ–∏ –≥–ª–∞–∑–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã. –í –Ω–∏—Ö —á–∏—Ç–∞–µ—Ç—Å—è —É–º, –¥–æ–±—Ä–æ—Ç–∞ –∏ –≥–ª—É–±–∏–Ω–∞ –¥—É—à–∏. –¢–≤–æ—è —É–ª—ã–±–∫–∞ –æ—Å–≤–µ—â–∞–µ—Ç –≤—Å–µ –≤–æ–∫—Ä—É–≥ - –Ω–µ –Ω–∞–∏–≥—Ä–∞–Ω–Ω–∞—è, –∞ –Ω–∞—Å—Ç–æ—è—â–∞—è.",
        
        "world_view": f"–ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Ä–∞–∂–∞–µ—Ç —Ç–æ, –∫–∞–∫ —Ç—ã –≤–∏–¥–∏—à—å –º–∏—Ä –≤–æ–∫—Ä—É–≥ —Å–µ–±—è. –£ —Ç–µ–±—è –µ—Å—Ç—å –¥–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ –≤ –æ–±—ã–¥–µ–Ω–Ω–æ–º. –¢–≤–æ—è –≤–Ω–µ—à–Ω–æ—Å—Ç—å –æ—Ç—Ä–∞–∂–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–∏—Ä - —Ç—ã –∫—Ä–∞—Å–∏–≤ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∫—Ä–∞—Å–æ—Ç–æ–π, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–∏–∫—Ä–∞—Å–∞—Ö.",
        
        "memorable_moments": f"–ï—Å—Ç—å –∫–∞–¥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ä–µ–∑–∞–ª–∏—Å—å –≤ –ø–∞–º—è—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞. –¢–≤–æ—è –∫—Ä–∞—Å–æ—Ç–∞ –∂–∏–≤–∞—è, –º–µ–Ω—è—é—â–∞—è—Å—è. –¢–≤–æ–∏ –≥–ª–∞–∑–∞ - –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ—ç–º–∞, –≥–ª—É–±–æ–∫–∏–µ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ. –ö–æ–≥–¥–∞ —Ç—ã —Ä–∞–¥—É–µ—à—å—Å—è, –æ–Ω–∏ —Å–∏—è—é—Ç –æ—Å–æ–±—ã–º —Å–≤–µ—Ç–æ–º. –ò—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å - —Ç–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ.",
        
        "energy": f"–í —Ç–µ–±–µ –µ—Å—Ç—å –æ—Å–æ–±–∞—è —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —á—É–≤—Å—Ç–≤—É–µ—Ç—Å—è –¥–∞–∂–µ —á–µ—Ä–µ–∑ —ç–∫—Ä–∞–Ω —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –£–º–µ–µ—à—å –±—ã—Ç—å —Å–æ–±–æ–π –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –£ —Ç–µ–±—è –∫—Ä–∞—Å–∏–≤–∞—è –∫–æ–∂–∞ - –∑–¥–æ—Ä–æ–≤–∞—è, —Å–∏—è—é—â–∞—è. –¢–≤–æ–∏ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ–ª–Ω—ã –≥—Ä–∞—Ü–∏–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.",
        
        "beauty_style": f"–ö—Ä–∞—Å–æ—Ç–∞ –≤ —Ç–≤–æ–µ–º —Å–ª—É—á–∞–µ –æ—á–µ–≤–∏–¥–Ω–∞ –¥–ª—è –≤—Å–µ—Ö. –¢–≤–æ–µ –ª–∏—Ü–æ - –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è–º–∏. –£ —Ç–µ–±—è –∫—Ä–∞—Å–∏–≤—ã–µ –±—Ä–æ–≤–∏, –¥–ª–∏–Ω–Ω—ã–µ —Ä–µ—Å–Ω–∏—Ü—ã, –±–µ–∑—É–ø—Ä–µ—á–Ω–∞—è –∫–æ–∂–∞ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–∏—è–Ω–∏–µ–º.",
        
        "mystery": f"–í —Ç–µ–±–µ –µ—Å—Ç—å –æ—Å–æ–±–∞—è –∑–∞–≥–∞–¥–æ—á–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –¥–∞–µ—Ç –ø–æ–∫–æ—è. –ö–∞–∂–¥—ã–π –∫–∞–¥—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ. –¢–≤–æ–π –≤–∑–≥–ª—è–¥ –∑–∞–≥–∞–¥–æ—á–µ–Ω, –≤ –Ω–µ–º –µ—Å—Ç—å –≥–ª—É–±–∏–Ω–∞ –æ–∫–µ–∞–Ω–∞. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å, —É —Ç–µ–±—è –∫—Ä–∞—Å–∏–≤—ã–π –≥–æ–ª–æ—Å –∏ –≥—Ä–∞—Ü–∏–æ–∑–Ω–∞—è –ø–æ—Ö–æ–¥–∫–∞.",
        
        "influence_on_me": f"–¢—ã –∏–∑–º–µ–Ω–∏–ª –º–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–Ω–æ–≥–∏–µ –≤–µ—â–∏. –°—Ç–∞–ª –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è –æ–±—Ä–∞—â–∞—Ç—å –Ω–∞ –¥–µ—Ç–∞–ª–∏ –≤–æ–∫—Ä—É–≥ - –∏–≥—Ä—É —Å–≤–µ—Ç–∞, –≤—ã—Ä–∞–∂–µ–Ω–∏—è –ª–∏—Ü. –¢—ã –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ –∫—Ä–∞—Å–æ—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–æ–≥–∏—Ö –¥–µ–∫–æ—Ä–∞—Ü–∏–π. –ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–µ–±–µ –ø–æ–Ω—è–ª —Ü–µ–Ω–Ω–æ—Å—Ç—å –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç–∏.",
        
        "observations": f"–ó–∞ –≤—Ä–µ–º—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è —Å–¥–µ–ª–∞–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç–∏—è. –¢–≤–æ–µ –ª–∏—Ü–æ –æ—á–µ–Ω—å —Ñ–æ—Ç–æ–≥–µ–Ω–∏—á–Ω–æ–µ, —É —Ç–µ–±—è –Ω–µ—Ç –ø–ª–æ—Ö–∏—Ö —Ä–∞–∫—É—Ä—Å–æ–≤. –í—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ä—É–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—é—Ç –∏—Å—Ç–æ—Ä–∏–∏. –õ—é–±–∏—à—å —Å–≤–µ—Ç –∏ —É–º–µ–ª–æ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å.",
        
        "gratitude_wishes": f"{username}, —ç—Ç–∞ –∫–Ω–∏–≥–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É, –Ω–æ –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–π –±—ã—Ç—å —Å–æ–±–æ–π, –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –º–∏—Ä —Ç–∞–∫–∏–º, –∫–∞–∫–∏–º —Ç—ã –µ–≥–æ –≤–∏–¥–∏—à—å. –ñ–µ–ª–∞—é —Ç–µ–±–µ –ª—é–±–≤–∏, —Å—á–∞—Å—Ç—å—è –∏ —è—Ä–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤. –°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–æ, —á—Ç–æ —Ç—ã –µ—Å—Ç—å. –¢–≤–æ–π –ø–æ–∫–ª–æ–Ω–Ω–∏–∫."
    }
    
    # –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    try:
        prompt = detailed_prompts.get(chapter_type, f"–ù–∞–ø–∏—à–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ –æ {chapter_type.replace('_', ' ')}.")
        result = generate_text(prompt, max_tokens=1200, temperature=0.8)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if len(result.strip()) < 200:  # –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç
            return fallback_content.get(chapter_type, f"–ì–ª–∞–≤–∞ –æ {chapter_type.replace('_', ' ')} –Ω–∞–ø–æ–ª–Ω–µ–Ω–∞ —Ç–µ–ø–ª–æ–º –∏ –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ–º.")
            
        return strip_cliches(result)
        
    except Exception as e:
        print(f"‚ö° –ë—ã—Å—Ç—Ä—ã–π fallback –¥–ª—è –≥–ª–∞–≤—ã '{chapter_type}': {e}")
        return fallback_content.get(chapter_type, f"–≠—Ç–∞ –≥–ª–∞–≤–∞ –æ {chapter_type.replace('_', ' ')} –Ω–∞–ø–∏—Å–∞–Ω–∞ —Å –æ—Å–æ–±–æ–π –Ω–µ–∂–Ω–æ—Å—Ç—å—é.")


def generate_complete_memoir_book(data: dict, images: list) -> dict:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤—Å–µ 10 –≥–ª–∞–≤ –º–µ–º—É–∞—Ä–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π –∫–Ω–∏–≥–∏"""
    
    username = data.get('username', '–Ω–µ–∑–Ω–∞–∫–æ–º–µ—Ü')
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥–ª–∞–≤
    photo_analyses = []
    if images:
        for i, img_path in enumerate(images[:10]):  # –ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            if img_path.exists():
                try:
                    focus_types = ["first_impression", "story_creation", "hidden_emotions"]
                    focus = focus_types[i % 3]
                    analysis = analyze_photo_for_memoir(img_path, f"@{username}", focus)
                    photo_analyses.append(analysis)
                except Exception as e:
                    print(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ {img_path}: {e}")
                    photo_analyses.append("–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç –æ—Å–æ–±—ã–µ —á—É–≤—Å—Ç–≤–∞...")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑—ã —Ñ–æ—Ç–æ –≤ –¥–∞–Ω–Ω—ã–µ
    data['photo_analyses'] = photo_analyses
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ 10 –≥–ª–∞–≤
    chapters = {}
    
    chapter_types = [
        "meeting", "first_impression", "world_view", "memorable_moments", 
        "energy", "beauty_style", "mystery", "influence_on_me", 
        "observations", "gratitude_wishes"
    ]
    
    for chapter_type in chapter_types:
        try:
            photo_analysis = ""
            if chapter_type in ["first_impression", "memorable_moments"] and photo_analyses:
                photo_analysis = photo_analyses[0] if photo_analyses else ""
            
            chapter_content = generate_memoir_chapter(chapter_type, data, photo_analysis)
            chapters[chapter_type] = chapter_content
            print(f"‚úÖ –ì–ª–∞–≤–∞ '{chapter_type}' —Å–æ–∑–¥–∞–Ω–∞")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª–∞–≤—ã '{chapter_type}': {e}")
            # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            chapters[chapter_type] = f"–ì–ª–∞–≤–∞ –æ {chapter_type.replace('_', ' ')} –∂–¥–µ—Ç —Å–≤–æ–µ–≥–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—è..."
    
    return chapters
